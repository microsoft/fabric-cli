name: ðŸš€ Create GitHub Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to release (e.g., v1.2.0)'
        required: true
      commit_sha:
        description: 'Optional: Commit SHA to create the tag on. If not provided, the tag will be created on the latest commit of the current branch (HEAD)'
        required: false
        default: ''

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to access full commit history for validation

      - name: Display workflow information
        run: |
          if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
            TARGET_INFO="- **Target Commit:** \`${{ github.event.inputs.commit_sha }}\`"
          else
            TARGET_INFO="- **Target Commit:** Latest commit on current branch (HEAD)"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸš€ Create Release Workflow
          
          ## â„¹ï¸ Workflow Information
          - **Version:** ${{ github.event.inputs.version }}
          $TARGET_INFO
          
          EOF

      - name: Validate commit SHA (if provided)
        if: ${{ github.event.inputs.commit_sha != '' }}
        run: |
          COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
          if ! git rev-parse --verify "$COMMIT_SHA^{commit}" >/dev/null 2>&1; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âŒ Error: Invalid Commit SHA
          
          The provided commit SHA \`$COMMIT_SHA\` is not valid or does not exist in this repository.
          
          ### ðŸ“ Troubleshooting
          - Verify the commit SHA exists in the repository
          - Ensure you are using the full commit SHA (or at least 7 characters)
          - Check that the commit is in the current branch history
          
          EOF
            echo "Error: Invalid commit SHA: $COMMIT_SHA"
            exit 1
          fi
          echo "âœ… Commit SHA validated successfully: $COMMIT_SHA"

      - name: Set up release variables
        id: set_vars
        run: |
          VERSION="${{ github.event.inputs.version }}"
          COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
          
          # Use provided commit SHA or default to HEAD
          if [ -n "$COMMIT_SHA" ]; then
            TARGET_COMMIT="$COMMIT_SHA"
          else
            TARGET_COMMIT="HEAD"
          fi
          
          echo "tag_name=$VERSION" >> $GITHUB_OUTPUT
          echo "changelog_file_path=.changes/${VERSION}.md" >> $GITHUB_OUTPUT
          echo "target_commit=$TARGET_COMMIT" >> $GITHUB_OUTPUT
          
          # Get the actual commit SHA for display
          ACTUAL_SHA=$(git rev-parse "$TARGET_COMMIT")
          echo "actual_sha=$ACTUAL_SHA" >> $GITHUB_OUTPUT
          
          echo "âœ… Release variables set:"
          echo "  - Tag name: $VERSION"
          echo "  - Target commit: $ACTUAL_SHA"
          echo "  - Changelog file: .changes/${VERSION}.md"

      - name: Validate release notes file
        run: |
          if [ ! -f "${{ steps.set_vars.outputs.changelog_file_path }}" ]; then
            echo "Error: Release notes file not found at ${{ steps.set_vars.outputs.changelog_file_path }}"
            exit 1
          fi

      - name: Create Release with GitHub CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ steps.set_vars.outputs.tag_name }} \
            --title "${{ steps.set_vars.outputs.tag_name }}" \
            --notes-file "${{ steps.set_vars.outputs.changelog_file_path }}"
