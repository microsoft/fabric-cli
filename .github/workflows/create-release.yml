name: ðŸš€ Create GitHub Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to release (e.g., v1.2.0)'
        required: true
      commit_sha:
        description: 'Optional: Commit SHA to create the tag on. If not provided, the tag will be created on the latest commit of the current branch (HEAD)'
        required: false
        default: ''

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to access full commit history for validation

      - name: Display workflow information
        run: |
          echo "# ðŸš€ Create Release Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ Workflow Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.commit_sha }}" ]; then
            echo "- **Target Commit:** \`${{ github.event.inputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Target Commit:** Latest commit on current branch (HEAD)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Validate commit SHA (if provided)
        if: ${{ github.event.inputs.commit_sha != '' }}
        run: |
          COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
          if ! git rev-parse --verify "$COMMIT_SHA^{commit}" >/dev/null 2>&1; then
            echo "## âŒ Error: Invalid Commit SHA" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The provided commit SHA \`$COMMIT_SHA\` is not valid or does not exist in this repository." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "- Verify the commit SHA exists in the repository" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure you are using the full commit SHA (or at least 7 characters)" >> $GITHUB_STEP_SUMMARY
            echo "- Check that the commit is in the current branch history" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Error: Invalid commit SHA: $COMMIT_SHA"
            exit 1
          fi
          echo "âœ… Commit SHA validated successfully: $COMMIT_SHA"

      - name: Set up release variables
        id: set_vars
        run: |
          VERSION="${{ github.event.inputs.version }}"
          COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
          
          # Use provided commit SHA or default to HEAD
          if [ -n "$COMMIT_SHA" ]; then
            TARGET_COMMIT="$COMMIT_SHA"
          else
            TARGET_COMMIT="HEAD"
          fi
          
          echo "tag_name=$VERSION" >> $GITHUB_OUTPUT
          echo "changelog_file_path=.changes/${VERSION}.md" >> $GITHUB_OUTPUT
          echo "target_commit=$TARGET_COMMIT" >> $GITHUB_OUTPUT
          
          # Get the actual commit SHA for display
          ACTUAL_SHA=$(git rev-parse "$TARGET_COMMIT")
          echo "actual_sha=$ACTUAL_SHA" >> $GITHUB_OUTPUT
          
          echo "âœ… Release variables set:"
          echo "  - Tag name: $VERSION"
          echo "  - Target commit: $ACTUAL_SHA"
          echo "  - Changelog file: .changes/${VERSION}.md"

      - name: Validate release notes file
        run: |
          CHANGELOG_FILE="${{ steps.set_vars.outputs.changelog_file_path }}"
          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "## âŒ Error: Release Notes File Not Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The release notes file was not found at the expected location:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$CHANGELOG_FILE" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ What to do:" >> $GITHUB_STEP_SUMMARY
            echo "1. Ensure you have created the changelog file for version \`${{ steps.set_vars.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "2. The file should be located at: \`.changes/${{ steps.set_vars.outputs.tag_name }}.md\`" >> $GITHUB_STEP_SUMMARY
            echo "3. You can use \`changie batch <version>\` to generate the changelog file" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‚ Available changelog files:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -1 .changes/*.md 2>/dev/null || echo "No changelog files found" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Error: Release notes file not found at $CHANGELOG_FILE"
            exit 1
          fi
          echo "âœ… Release notes file found at: $CHANGELOG_FILE"

      - name: Create Release with GitHub CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "## ðŸ—ï¸ Creating Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Creating release with the following details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ steps.set_vars.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Commit:** \`${{ steps.set_vars.outputs.actual_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Notes File:** \`${{ steps.set_vars.outputs.changelog_file_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create the release with the target commit
          if gh release create ${{ steps.set_vars.outputs.tag_name }} \
            --title "${{ steps.set_vars.outputs.tag_name }}" \
            --notes-file "${{ steps.set_vars.outputs.changelog_file_path }}" \
            --target "${{ steps.set_vars.outputs.target_commit }}"; then
            
            echo "## âœ… Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Release \`${{ steps.set_vars.outputs.tag_name }}\` has been created!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Release Details:" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** \`${{ steps.set_vars.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** \`${{ steps.set_vars.outputs.actual_sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Release URL:** [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.set_vars.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Error: Failed to Create Release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The GitHub CLI failed to create the release. This could be due to:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Common Issues:" >> $GITHUB_STEP_SUMMARY
            echo "- A release with tag \`${{ steps.set_vars.outputs.tag_name }}\` already exists" >> $GITHUB_STEP_SUMMARY
            echo "- Insufficient permissions to create releases" >> $GITHUB_STEP_SUMMARY
            echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY
            echo "- Invalid release notes format" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Check if the tag already exists: \`git tag -l '${{ steps.set_vars.outputs.tag_name }}'\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify you have the necessary permissions to create releases" >> $GITHUB_STEP_SUMMARY
            echo "3. Review the workflow run logs for detailed error messages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Error: Failed to create release"
            exit 1
          fi
